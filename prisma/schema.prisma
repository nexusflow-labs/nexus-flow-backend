// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider     = "prisma-client"
  output       = "../generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// WORKSPACE & MEMBERS
// ============================================

model Workspace {
  id          String       @id @default(uuid())
  name        String
  description String?
  members     Member[]
  projects    Project[]
  labels      Label[]
  invitations Invitation[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  deletedAt   DateTime?
}

model Member {
  id          String    @id @default(uuid())
  role        String // OWNER, ADMIN, MEMBER
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now())

  @@unique([workspaceId, userId])
  @@index([userId])
}

model Invitation {
  id          String    @id @default(uuid())
  email       String
  role        String    @default("MEMBER")
  token       String    @unique
  status      String    @default("PENDING") // PENDING, ACCEPTED, EXPIRED, CANCELLED
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  invitedById String
  invitedBy   User      @relation(fields: [invitedById], references: [id])
  expiresAt   DateTime
  createdAt   DateTime  @default(now())

  @@index([workspaceId])
  @@index([email])
  @@index([token])
}

// ============================================
// USER & AUTH
// ============================================

model User {
  id             String       @id @default(uuid())
  email          String       @unique
  password       String
  fullName       String
  avatar         String?
  isActive       Boolean      @default(true)
  members        Member[]
  createdTasks   Task[]       @relation("TaskCreator")
  assignedTasks  Task[]       @relation("TaskAssignee")
  ownedProjects  Project[]
  comments       Comment[]
  activityLogs   ActivityLog[]
  invitations    Invitation[]
  refreshTokens  RefreshToken[]
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
  revokedAt DateTime?

  @@index([userId])
  @@index([token])
}

// ============================================
// PROJECT
// ============================================

model Project {
  id          String    @id @default(uuid())
  name        String
  description String?
  status      String    @default("ACTIVE") // ACTIVE, ARCHIVED, COMPLETED
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  ownerId     String
  owner       User      @relation(fields: [ownerId], references: [id])
  tasks       Task[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  @@index([workspaceId])
  @@index([ownerId])
}

// ============================================
// TASK & RELATED
// ============================================

model Task {
  id          String      @id @default(uuid())
  title       String
  description String?
  priority    String      @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT
  status      String      @default("TODO") // TODO, IN_PROGRESS, IN_REVIEW, DONE
  dueDate     DateTime?
  position    Int         @default(0) // For ordering tasks
  projectId   String
  project     Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assigneeId  String?
  assignee    User?       @relation("TaskAssignee", fields: [assigneeId], references: [id])
  creatorId   String
  creator     User        @relation("TaskCreator", fields: [creatorId], references: [id])
  parentId    String?
  parent      Task?       @relation("Subtasks", fields: [parentId], references: [id])
  subtasks    Task[]      @relation("Subtasks")
  comments    Comment[]
  labels      TaskLabel[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  deletedAt   DateTime?

  @@index([projectId])
  @@index([assigneeId])
  @@index([creatorId])
  @@index([status])
  @@index([parentId])
}

model Comment {
  id        String   @id @default(uuid())
  content   String
  taskId    String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  authorId  String
  author    User     @relation(fields: [authorId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([taskId])
  @@index([authorId])
}

// ============================================
// LABELS
// ============================================

model Label {
  id          String      @id @default(uuid())
  name        String
  color       String      @default("#6B7280") // Gray as default
  workspaceId String
  workspace   Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  tasks       TaskLabel[]
  createdAt   DateTime    @default(now())

  @@unique([workspaceId, name])
  @@index([workspaceId])
}

model TaskLabel {
  taskId    String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  labelId   String
  label     Label    @relation(fields: [labelId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@id([taskId, labelId])
  @@index([taskId])
  @@index([labelId])
}

// ============================================
// ACTIVITY LOG
// ============================================

model ActivityLog {
  id         String   @id @default(uuid())
  action     String // CREATE, UPDATE, DELETE, ASSIGN, UNASSIGN, COMMENT, STATUS_CHANGE
  entityType String // WORKSPACE, PROJECT, TASK, MEMBER, COMMENT
  entityId   String
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  metadata   Json? // Store additional context (old values, new values, etc.)
  createdAt  DateTime @default(now())

  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
}
